@startuml
!theme materia-outline

skinparam ArrowColor #9803fc
skinparam BackgroundColor #FFFFFF
skinparam ArrowColor #9803fc
skinparam ActorBorderColor #9803fc
skinparam ActorFontColor #9803fc
skinparam ActorBackgroundColor #9803fc
skinparam ParticipantFontColor #9803fc
skinparam ParticipantBorderColor #9803fc
skinparam ParticipantBackgroundColor #FFFFFF
skinparam {
 SequenceGroupBorderColor #9803fc
}

actor User
participant Display
participant Parser
participant CmdFight
participant ApplicationContext
participant Game
participant Command
participant StorageService

User -> Display: fight
Display -> Parser: fight
Parser -> CmdFight

CmdFight -> ApplicationContext: getGame()
ApplicationContext --> CmdFight
CmdFight -> Game: getPlayer(), getCurrentNode(), getMonster()
Game --> CmdFight

alt currentNode instanceof Room && monster != null
  alt monster isAlive()
    CmdFight -> Parser: enable fight commands and \ndisable all other commands
    CmdFight -> Game: setFightStatus(true) of the player
    CmdFight -> CmdFight: reset player dodge \nreset monster dodge \nreset monster hp    
    loop player isAlive && monster isAlive && battle isActive
      CmdFight -> Parser: gets the command from the user input
      Parser --> CmdFight
      alt command = one of the fight command;
        CmdFight -> Command: execute
        Command --> CmdFight
      else command = null;
        CmdFight -> User: "Unknown command"
      end
    end
    CmdFight -> Parser:  enable all commands and disable fight commands
    alt Player isAlive && Player isFigthing
      CmdFight -> User: "You won"
      CmdFight -> CmdFight: setFightStatus(false) of the player
      alt inventory of the monster is not empty
        CmdFight -> Game: remove items from monster inventory\n and place them inside currentNode
      end
    else
      CmdFight -> Parser: disable all commands and \nwait for the user to press Enter
      User -> Display: presses Enter
      Display -> CmdFight
      CmdFight -> ApplicationContext: getStorageService
      ApplicationContext --> CmdFight
      CmdFight -> StorageService: get a newGame with the same player name
      StorageService --> CmdFight
      CmdFight -> User: new game starts
    end
  else
    CmdFight -> User: "No monster to fight"
  end
else
  CmdFight -> User: "Can't fight in this room"
end
@enduml